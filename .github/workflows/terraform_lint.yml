name: Terraform Lint and Plan
on:
    workflow_dispatch:
    pull_request:
        paths:
            - 'terraform/**'

jobs:
    Lint:
        name: Lint
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: terraform
        steps:
            - name: Checkout code
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
            
            - name: Cache Plugin Directory
              uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
              with:
                path: ~/.tflint.d/plugins
                key: ${{ runner.os }}-tflint-${{ hashFiles('terraform/.tflint.hcl') }}

            - name: Set up TFlint
              uses: terraform-linters/setup-tflint@90f302c255ef959cbfb4bd10581afecdb7ece3e6 # v4.1.1
              with:
                tflint_version: v0.57.0
            - name: Show version
              run: tflint --version
            
            - name: Init TFlint
              run: tflint --init
              env:
                GITHUB_TOKEN: ${{ github.token }}

            - name: Run TFlint
              run: tflint --recursive -f compact
